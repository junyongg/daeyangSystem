<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="INVERTER"> 


	<delete id="deletePcsSolar">
		DELETE FROM PCS_SOLAR_DATA 
			WHERE PSD_KEYNO != (SELECT MAX(PSD_KEYNO)FROM PCS_SOLAR_DATA) 
	</delete>

	<delete id="deleteEmsData">
		DELETE FROM EMS 
			WHERE EMS_KEYNO != (SELECT MAX(EMS_KEYNO)FROM EMS) 
	</delete>

	
	<delete id="deleteInverter_one">
		DELETE FROM INVERTER_ONE 
			WHERE IV_KEYNO != (SELECT MAX(IV_KEYNO)FROM INVERTER_ONE)
	</delete>
	
	<insert id="InverterInsert">
		<![CDATA[
		INSERT INTO INVERTER(IO_POWER , IO_USAGE , IO_CHARGE , IO_STATUS, IO_CO2 , IO_CASH	)VALUES
			(
				(SELECT PSD_VALUE - IFNULL((SELECT PSD_VALUE FROM PCS_SOLAR_DATA B WHERE B.PSD_DATE < A.PSD_DATE AND DATE_FORMAT(B.PSD_DATE,'%Y-%m-%d')  =  CURDATE() ORDER BY B.PSD_DATE DESC LIMIT 1),0)FROM PCS_SOLAR_DATA A WHERE DATE_FORMAT(PSD_DATE,'%Y-%m-%d')  =  CURDATE() ORDER BY PSD_DATE DESC LIMIT 1),
				(SELECT Total_Wh - IFNULL((SELECT Total_Wh FROM DISTRIBUTION_BOARD B WHERE B.Date_time < A.Date_time AND DATE_FORMAT(B.Date_time,'%Y-%m-%d')  =  CURDATE() ORDER BY B.Date_time DESC LIMIT 1),0)FROM DISTRIBUTION_BOARD A WHERE DATE_FORMAT(Date_time,'%Y-%m-%d')  =  CURDATE() ORDER BY Date_time DESC LIMIT 1),
				(SELECT SOC FROM EMS ORDER BY EMS_KEYNO DESC LIMIT 1) , 
				IF(STRCMP((SELECT onoff FROM EMS ORDER BY EMS_KEYNO DESC limit 1),1)=0,'on','off'),
				ROUND((SELECT PSD_VALUE * 0.1213 FROM PCS_SOLAR_DATA ORDER BY PSD_KEYNO DESC LIMIT 1),4), 
				ROUND((SELECT PSD_VALUE * 0.002651 FROM PCS_SOLAR_DATA ORDER BY PSD_KEYNO DESC LIMIT 1),2)
			)
		]]>
	</insert>
	
</mapper>