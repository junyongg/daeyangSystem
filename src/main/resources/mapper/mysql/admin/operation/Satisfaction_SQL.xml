<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="Satisfaction"> 
	
	
	<sql id="TPS_getListBody">
		FROM (
			SELECT	AB.*, @ROWNUM:=@ROWNUM+1 as COUNT
			FROM (
				SELECT	TPS_MN_KEYNO
		        		, B.MN_NAME
		                , C.MN_NAME MN_HOMEDIV_NAME
		                , CONCAT(TOTAL,'명') TOTAL_CNT
		                , CONCAT(SCORE1,'명',IF(SCORE1 = 0,'',CONCAT('(',FORMAT(SCORE1/TOTAL*100,2),'%)')) ) SCORE_DATA1
		                , CONCAT(SCORE2,'명',IF(SCORE2 = 0,'',CONCAT('(',FORMAT(SCORE2/TOTAL*100,2),'%)')) ) SCORE_DATA2
		                , CONCAT(SCORE3,'명',IF(SCORE3 = 0,'',CONCAT('(',FORMAT(SCORE3/TOTAL*100,2),'%)')) ) SCORE_DATA3
		                , CONCAT(SCORE4,'명',IF(SCORE4 = 0,'',CONCAT('(',FORMAT(SCORE4/TOTAL*100,2),'%)')) ) SCORE_DATA4
		                , CONCAT(SCORE5,'명',IF(SCORE5 = 0,'',CONCAT('(',FORMAT(SCORE5/TOTAL*100,2),'%)')) ) SCORE_DATA5
		                , CASE 
		                	WHEN SCORE5 >= SCORE4 AND SCORE5 >= SCORE3 AND SCORE5 >= SCORE2 AND SCORE5 >= SCORE1 THEN '매우 만족'
		                    WHEN SCORE4 >= SCORE3 AND SCORE4 >= SCORE2 AND SCORE4 >= SCORE1 THEN '만족'
		                    WHEN SCORE3 >= SCORE2 AND SCORE3 >= SCORE1 THEN '보통'
		                    WHEN SCORE2 >= SCORE1 THEN '불만족'
		                    ELSE '매우 불만족'
		                END RESULT_DATA
		               
		        FROM (
		        	SELECT 	  TPS_MN_KEYNO
		            		, COUNT(TPS_SCORE_NAME) AS TOTAL
		                    , COUNT(IF(TPS_SCORE = 1,1,NULL)) SCORE1
		                    , COUNT(IF(TPS_SCORE = 2,1,NULL)) SCORE2
		                    , COUNT(IF(TPS_SCORE = 3,1,NULL)) SCORE3
		                    , COUNT(IF(TPS_SCORE = 4,1,NULL)) SCORE4
		                    , COUNT(IF(TPS_SCORE = 5,1,NULL)) SCORE5
		            FROM T_PAGE_RESEARCH_MANAGER TPR
		            LEFT JOIN S_MENU_MANAGER TMM
		            ON		TPR.TPS_MN_KEYNO = TMM.MN_KEYNO
		            GROUP BY  TPS_MN_KEYNO
		        ) A 
		        LEFT JOIN S_MENU_MANAGER B
		        ON	A.TPS_MN_KEYNO = B.MN_KEYNO
		        LEFT JOIN S_MENU_MANAGER C
		        <choose>
		        	<when test="mainkey != null and mainkey !=''">
		        ON	(B.MN_HOMEDIV_C = C.MN_KEYNO AND B.MN_HOMEDIV_C IS NOT NULL)
	 				</when>
	 				<otherwise>
		        ON	(B.MN_HOMEDIV_C = C.MN_KEYNO AND B.MN_HOMEDIV_C = #{HOMEDIV_C})
					</otherwise>
		        </choose>
		        <if test="UIA_KEYNO != 'UIA_ASDFG'">
		        LEFT JOIN U_USERINFO_AUTHORITY_ROLL UAR
				ON		UAR.MN_KEYNO = A.TPS_MN_KEYNO
				</if>
				<if test="UIA_KEYNO != 'UIA_ASDFG'">
				WHERE 	UAR.UIA_KEYNO		=	#{UIA_KEYNO}
				</if> 

			) AB
		WHERE 1=1		
		AND AB.MN_HOMEDIV_NAME IS NOT NULL
		 
		AND (@ROWNUM:=0)=0
		<if test="mainkey != null and mainkey !=''">
		ORDER BY TOTAL_CNT DESC
		</if>
		)AA
		WHERE 1=1
		<if test="searchList != null">
	 	<foreach collection="searchList" item="item">
	 		<choose>
	 			<when test='item.searchIndex.equals("1")'>
 		AND		COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("2")'>
 		AND		MN_NAME 				LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("3")'>
 		AND		TOTAL_CNT				LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("4")'>
 		AND		SCORE_DATA5 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("5")'>
 		AND		SCORE_DATA4 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("6")'>
 		AND		SCORE_DATA3 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("7")'>
 		AND		SCORE_DATA2 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("8")'>
 		AND		SCORE_DATA1 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("9")'>
 		AND		RESULT_DATA 			LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("all")'>
 		AND (
 				COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				MN_NAME 				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TOTAL_CNT				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				SCORE_DATA5 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				SCORE_DATA4 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				SCORE_DATA3 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				SCORE_DATA2 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				SCORE_DATA1 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				RESULT_DATA 			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	
 		)							
	 			</when>
	 		</choose>
	 	</foreach>
	 	</if>
	
	</sql>
  	
    <select id="TPS_getListCnt" resultType="int" parameterType="hashmap">
		SELECT	COUNT(*)
		<include  refid="TPS_getListBody"/>
    </select>
    
    <select id="TPS_getList" resultMap="ResultMap.rownumHashMap">
    	SELECT *
		<include  refid="TPS_getListBody"/>
		<choose>
	 		<when test="orderBy == 1">
	 		ORDER BY	COUNT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 2">
	 		ORDER BY	MN_HOMEDIV_NAME ${sortDirect}
	 		</when>
	 		<when test="orderBy == 3">
	 		ORDER BY	MN_NAME ${sortDirect}
	 		</when>
	 		<when test="orderBy == 4">
	 		ORDER BY	TOTAL_CNT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 5">
	 		ORDER BY	SCORE_DATA5 ${sortDirect}
	 		</when>
	 		<when test="orderBy == 6">
	 		ORDER BY	SCORE_DATA4 ${sortDirect}
	 		</when>
	 		<when test="orderBy == 7">
	 		ORDER BY	SCORE_DATA3 ${sortDirect}
	 		</when>
	 		<when test="orderBy == 8">
	 		ORDER BY	SCORE_DATA2 ${sortDirect}
	 		</when>
	 		<when test="orderBy == 9">
	 		ORDER BY	SCORE_DATA1 ${sortDirect}
	 		</when>
	 		<when test="orderBy == 10">
	 		ORDER BY	RESULT_DATA ${sortDirect}
	 		</when>
	 		<otherwise>
	 		ORDER BY 	COUNT
	 		</otherwise>
 		</choose>
		<if test=" recordCountPerPage != 0">
		LIMIT  	#{recordCountPerPage} OFFSET #{firstIndex} 
		</if>  
    </select>
    
    
    
    <sql id="TPS_getDetailListBody">
		FROM (
			SELECT	AB.*
					, @ROWNUM:=@ROWNUM+1 as COUNT
			FROM (
				SELECT 	  	LEFT(TPR.TPS_REGDT, 10) AS TPS_REGDT
			   				, TPS_IP
			   				, TPS_COMMENT
			   				, TPS_SCORE_NAME
		        FROM 		T_PAGE_RESEARCH_MANAGER TPR
		        WHERE 		TPS_MN_KEYNO = #{TPS_MN_KEYNO}
		        ORDER BY 	TPS_REGDT DESC
			) AB
			WHERE (@ROWNUM:=0)=0
		)AA
		WHERE 1=1
		
		<if test="searchList != null">
	 	<foreach collection="searchList" item="item">
	 		<choose>
	 			<when test='item.searchIndex.equals("1")'>
 		AND		COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("2")'>
 		AND		TPS_SCORE_NAME			LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("3")'>
 		AND		TPS_IP 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("4")'>
 		AND		TPS_COMMENT				LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("5")'>
 		AND		TPS_REGDT 				LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("all")'>
 		AND (
 				COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_SCORE_NAME			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_IP 					LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_COMMENT				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_REGDT 				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	
 		)							
	 			</when>
	 		</choose>
	 	</foreach>
	 	</if>
	
	</sql>
  	
    <select id="TPS_getDetailListCnt" resultType="int">
		SELECT	COUNT(*)
		<include  refid="TPS_getDetailListBody"/>
    </select>
    
    <select id="TPS_getDetailList" resultMap="ResultMap.rownumHashMap">
    	SELECT	* 
		<include  refid="TPS_getDetailListBody"/>
		<choose>
	 		<when test="orderBy == 1">
	 		ORDER BY	COUNT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 2">
	 		ORDER BY	TPS_SCORE_NAME ${sortDirect}
	 		</when>
	 		<when test="orderBy == 3">
	 		ORDER BY	TPS_IP ${sortDirect}
	 		</when>
	 		<when test="orderBy == 4">
	 		ORDER BY	TPS_COMMENT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 5">
	 		ORDER BY	TPS_REGDT ${sortDirect}
	 		</when>
	 		<otherwise>
	 		ORDER BY 	COUNT
	 		</otherwise>
 		</choose>
		<if test=" recordCountPerPage != 0">
		LIMIT  	#{recordCountPerPage} OFFSET #{firstIndex} 
		</if>  
    </select>
    
  <!-- 코멘트페이지 SQL --> 
    
      <sql id="TPS_getCommentDetailListBody">
		FROM (
			SELECT	*
			FROM (
				SELECT 	  	
							(RANK() OVER(ORDER BY TPR.TPS_REGDT DESC)) COUNT
							, LEFT(TPR.TPS_REGDT, 10) AS TPS_REGDT
			   				, TPS_IP
			   				, TPS_COMMENT
			   				, TPS_SCORE_NAME
			   				, TPS_MN_KEYNO
			   				, TMM.MN_NAME AS MN_NAME
			   				
		        FROM 		T_PAGE_RESEARCH_MANAGER TPR
					LEFT JOIN S_MENU_MANAGER TMM
		            ON		TPR.TPS_MN_KEYNO = TMM.MN_KEYNO
		       		<if test="UIA_KEYNO != 'UIA_ASDFG'">
		       		LEFT JOIN U_USERINFO_AUTHORITY_ROLL UAR
		       		ON		UAR.MN_KEYNO = TPR.TPS_MN_KEYNO
		       		</if>
		        WHERE MN_NAME IS NOT NULL
		        <if test="UIA_KEYNO != 'UIA_ASDFG'">
		        AND		UAR.UIA_KEYNO		=	#{UIA_KEYNO}
		        </if> 
		        AND (TPS_COMMENT IS NOT NULL AND TPS_COMMENT != '')
		        AND TMM.MN_HOMEDIV_C = #{HOMEDIV_C}
		             ORDER BY 	TPS_REGDT DESC 
			) AB
		)AA
		WHERE 1=1
	    
		
		<if test="searchList != null">
	 	<foreach collection="searchList" item="item">
	 		<choose>
	 			<when test='item.searchIndex.equals("1")'>
 		AND		COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 				<when test='item.searchIndex.equals("2")'>
 		AND		MN_NAME 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("3")'>
 		AND		TPS_SCORE_NAME			LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("4")'>
 		AND		TPS_IP 					LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("5")'>
 		AND		TPS_COMMENT				LIKE CONCAT( '%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("6")'>
 		AND		TPS_REGDT 				LIKE CONCAT( '%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("all")'>
 		AND (
 				COUNT 					LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_SCORE_NAME			LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_IP 					LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				TPS_COMMENT				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	OR
 				MN_NAME 				LIKE CONCAT( '%',#{item.searchKeyword},'%')		OR
 				TPS_REGDT 				LIKE CONCAT( '%',#{item.searchKeyword},'%') 	
 		)							
	 			</when>
	 		</choose>
	 	</foreach>
	 	</if>
	
	</sql>
	
	 <select id="TPS_getCommentDetailListCnt" resultType="int">
		SELECT	COUNT(*)
		<include  refid="TPS_getCommentDetailListBody"/>
    </select>
    
    <select id="TPS_getCommentDetailList" resultMap="ResultMap.rownumHashMap">
    	SELECT	* 
		<include  refid="TPS_getCommentDetailListBody"/>
		<choose>
	 		<when test="orderBy == 1">
	 		ORDER BY	COUNT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 2">
	 		ORDER BY	MN_NAME ${sortDirect}
	 		</when>
	 		<when test="orderBy == 3">
	 		ORDER BY	TPS_SCORE_NAME ${sortDirect}
	 		</when>
	 		<when test="orderBy == 4">
	 		ORDER BY	TPS_IP ${sortDirect}
	 		</when>
	 		<when test="orderBy == 5">
	 		ORDER BY	TPS_COMMENT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 6">
	 		ORDER BY	TPS_REGDT ${sortDirect}
	 		</when>
	 		<otherwise>
	 		ORDER BY 	COUNT
	 		</otherwise>
 		</choose>
		<if test=" recordCountPerPage != 0">
		LIMIT  	#{recordCountPerPage} OFFSET #{firstIndex} 
		</if>  
    </select>
    
    
	
    <!-- 페이지 평가 등록  -->
    <insert id="TPS_Insert">
    	INSERT INTO T_PAGE_RESEARCH_MANAGER
    	(
			 TPS_KEYNO
			,TPS_MN_KEYNO
			,TPS_SCORE
			,TPS_COMMENT
			,TPS_REGDT
			,TPS_IP
			,TPS_SCORE_NAME
    	)
    	VALUES
    	(
    		 #{TPS_KEYNO}
			,#{TPS_MN_KEYNO}
			,#{TPS_SCORE}
			,#{TPS_COMMENT}
			,SYSDATE()
			,#{TPS_IP}
			,#{TPS_SCORE_NAME}
    	)
    </insert>
    
    <!-- 하루에 한번만 체크가능 -->
    <select id="TPS_Select" resultType="int">
   		SELECT COUNT(*)
	    FROM T_PAGE_RESEARCH_MANAGER
	    WHERE TPS_IP = #{TPS_IP}
	      AND TPS_MN_KEYNO =  #{TPS_MN_KEYNO}
	      AND LEFT(TPS_REGDT, 10) = LEFT(now(), 10)
    </select>
    
    <!-- 결과 보기 -->
    <select id="ResultList" resultType="Hashmap">
   		SELECT TPS_SCORE, TPS_SCORE_NAME, COUNT(*) AS COUNT
	    FROM T_PAGE_RESEARCH_MANAGER
	    WHERE TPS_MN_KEYNO = #{TPS_MN_KEYNO}
	    GROUP BY TPS_SCORE
    </select>
    
    <!-- 페이지 이름 -->
    <select id="TPS_MenuName" resultType="String">
	    SELECT    TMM.MN_NAME
		FROM T_PAGE_RESEARCH_MANAGER TPR
		LEFT JOIN S_MENU_MANAGER TMM
        ON	TPR.TPS_MN_KEYNO = TMM.MN_KEYNO
        WHERE TPR.TPS_MN_KEYNO = #{TPS_MN_KEYNO}
        GROUP BY TPS_MN_KEYNO
    </select>
    
    <!-- 커멘트 보기 -->
    <select id="TPS_PageDataList" resultType="Hashmap">
	   	SELECT @ROWNUM:=@ROWNUM+1 as COUNT, A.*
		FROM (
			SELECT	 TPR.*,
		       		 TMM.MN_NAME
		       		 <!-- COUNT(TPR.TPS_SCORE_NAME) CNT,
		       		 SUM(TPR.TPS_SCORE) SumScore -->
		FROM T_PAGE_RESEARCH_MANAGER TPR
		LEFT JOIN S_MENU_MANAGER TMM
		ON		TPR.TPS_MN_KEYNO = TMM.MN_KEYNO
		WHERE TPS_MN_KEYNO = #{TPS_MN_KEYNO}
		GROUP BY TPS_SCORE_NAME
		ORDER BY TPS_SCORE DESC
	      ) A
		,(SELECT @ROWNUM:=0)TMP
    </select>
    
     <!-- 페이지 평가 스킨 등록  -->
    <insert id="PRS_insert">
    	INSERT INTO T_PAGE_RESEARCH_SKIN
    	(
			 PRS_KEYNO
			,PRS_FORM
			,PRS_REGDT
			,PRS_REGNM
			,PRS_SUBJECT
    	)
    	VALUES
    	(
    		 #{PRS_KEYNO}
			,#{PRS_FORM}
			,NOW()
			,#{PRS_REGNM}
			,#{PRS_SUBJECT}
    	)
    </insert>
    
    <select id="PRS_getData" resultType="hashmap">
     SELECT  DATE_FORMAT(A.PRS_REGDT, '%Y-%m-%d %H:%s:%m') PRS_REGDT
			, DATE_FORMAT(A.PRS_MODDT, '%Y-%m-%d %H:%s:%m') PRS_MODDT
			, IFNULL(U.UI_REP_NAME,PRS_REGNM) PRS_REGNM
		    , IFNULL(U2.UI_REP_NAME,PRS_MODNM) PRS_MODNM
     		, A.*
     FROM T_PAGE_RESEARCH_SKIN A
	 LEFT JOIN U_USERINFO U
	 ON		A.PRS_REGNM	=	U.UI_ID
	 LEFT JOIN U_USERINFO U2
	 ON		A.PRS_MODNM	=	U2.UI_ID     
     WHERE PRS_DEL_YN = 'N'
     	<if test="PRS_KEYNO != null and PRS_KEYNO != ''">
		AND PRS_KEYNO = #{PRS_KEYNO}
		</if>
    </select>
    
      	<sql id="PRS_getListBody">
		FROM(
			SELECT 	  PRS_KEYNO
					, @rownum:=@rownum+1 as COUNT
		    		, LEFT(PRS_REGDT,10) PRS_REGDT
		    		, LEFT(PRS_MODDT,10) PRS_MODDT
		    		, IFNULL(U.UI_REP_NAME,PRS_REGNM) PRS_UI_NAME
		    		, IFNULL(U2.UI_REP_NAME,PRS_MODNM) PRS_MODNM
		    		, PRS_SUBJECT
		    		, (CASE (SELECT COUNT(*) FROM S_HOME_MANAGER WHERE HM_RESEARCH_SKIN = PRS_KEYNO)
		    				 WHEN 0 THEN 'N' ELSE 'Y' END) PRS_USE
		    FROM	T_PAGE_RESEARCH_SKIN P 
		    LEFT JOIN U_USERINFO U
		    ON		P.PRS_REGNM	=	U.UI_ID
		    LEFT JOIN U_USERINFO U2
		    ON		P.PRS_MODNM	=	U2.UI_ID		    
		    ,(SELECT @rownum:=0)TMP
			WHERE PRS_DEL_YN = 'N'
		)AA
		WHERE 1=1
		
		<if test="searchList != null">
	 	<foreach collection="searchList" item="item">
	 		<choose>
	 			<when test='item.searchIndex.equals("1")'>
 		AND		COUNT 						LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("2")'>
 		AND		PRS_SUBJECT					LIKE CONCAT('%',#{item.searchKeyword},'%')						
	 			</when>
	 			<when test='item.searchIndex.equals("3")'>
 		AND		PRS_REGNM					LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("4")'>
 		AND		PRS_REGDT 					LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("5")'>
 		AND		PRS_MODNM 					LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("6")'>
 		AND		PRS_MODDT 					LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>
	 			<when test='item.searchIndex.equals("7")'>
 		AND		PRS_USE 					LIKE CONCAT('%',#{item.searchKeyword},'%')					
	 			</when>	 				 				 			
	 			<when test='item.searchIndex.equals("all")'>
 		AND (
 				COUNT 					LIKE CONCAT('%',#{item.searchKeyword},'%') 				OR
 				PRS_SUBJECT 			LIKE CONCAT('%',#{item.searchKeyword},'%') 				OR
 				PRS_REGNM				LIKE CONCAT('%',#{item.searchKeyword},'%') 				OR
 				PRS_REGDT 				LIKE CONCAT('%',#{item.searchKeyword},'%')				OR
 				PRS_MODNM 				LIKE CONCAT('%',#{item.searchKeyword},'%')				OR
 				PRS_MODDT 				LIKE CONCAT('%',#{item.searchKeyword},'%')				OR
 				PRS_USE 				LIKE CONCAT('%',#{item.searchKeyword},'%')				
 		)							
	 			</when>
	 		</choose>
	 	</foreach>
	 	</if>
		
	</sql>
	
	   <select id="PRS_getListCnt" resultType="int">
			SELECT	COUNT(*)
		<include  refid="PRS_getListBody"/>
    </select>
    
        <select id="PRS_getList" resultMap="ResultMap.rownumHashMap">
		SELECT	*
		<include  refid="PRS_getListBody"/>
		
		<choose>
	 		<when test="orderBy == 1">
	 		ORDER BY	COUNT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 2">
	 		ORDER BY	PRS_SUBJECT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 3">
	 		ORDER BY	PRS_REGNM ${sortDirect}
	 		</when>
	 		<when test="orderBy == 4">
	 		ORDER BY	PRS_REGDT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 5">
	 		ORDER BY	PRS_MODNM ${sortDirect}
	 		</when>
	 		<when test="orderBy == 6">
	 		ORDER BY	PRS_MODDT ${sortDirect}
	 		</when>
	 		<when test="orderBy == 7">
	 		ORDER BY	PRS_USE ${sortDirect}
	 		</when>	 			 			 		
	 		<otherwise>
	 		ORDER BY PRS_KEYNO DESC
	 		</otherwise>
	 	</choose>
		<if test="recordCountPerPage != 0">
		 	LIMIT  	#{recordCountPerPage} OFFSET #{firstIndex}
		</if> 	
		
    </select>
    
        <select id="PRS_getFormList" resultType="hashmap">
    SELECT PRS_KEYNO, PRS_FORM, PRS_SUBJECT, CONCAT('FORM', CAST(RIGHT(PRS_KEYNO,10) AS UNSIGNED)) FORM_NAME
    FROM T_PAGE_RESEARCH_SKIN
    WHERE PRS_DEL_YN = 'N'
    </select>
    
        <update id="PRS_update">
    	UPDATE T_PAGE_RESEARCH_SKIN
    	SET   PRS_SUBJECT = #{PRS_SUBJECT}
    		, PRS_FORM = #{PRS_FORM}
    		, PRS_MODDT = NOW()
    		, PRS_MODNM = #{PRS_MODNM}
    	WHERE PRS_KEYNO = #{PRS_KEYNO}
    </update>
    
    <update id="PRS_delete">
    	UPDATE T_PAGE_RESEARCH_SKIN
    	SET PRS_DEL_YN = 'Y'
    	WHERE PRS_KEYNO = #{PRS_KEYNO}
    </update>
    
     <!-- 스킨 히스토리 리스트 -->
	<select id="PRSH_getList" resultType="hashmap">
		SELECT 		  DATE_FORMAT(A.PRSH_STDT, '%Y-%m-%d %H:%i:%s') PRSH_STDT_B
			 		, DATE_FORMAT(A.PRSH_ENDT, '%Y-%m-%d %H:%i:%s') PRSH_ENDT_B
		   			, IFNULL(U.UI_REP_NAME,PRSH_MODNM) PRSH_MODNM
					, A.*
		FROM		T_PAGE_RESEARCH_SKIN_HISTORY A
		LEFT JOIN U_USERINFO U
		ON		A.PRSH_MODNM	=	U.UI_ID 		
		WHERE		PRSH_PRS_KEYNO	=	#{PRS_KEYNO}
		AND			PRSH_DEL_YN		=	'N'
		ORDER BY	PRSH_ENDT DESC
	</select>
	
		<!-- 스킨 히스토리 작성일 -->
	<select id="get_historyDate" resultType="String">
		SELECT 	CASE WHEN PRS_MODDT IS NULL THEN PRS_REGDT ELSE PRS_MODDT END REGDT
		FROM 	T_PAGE_RESEARCH_SKIN
		WHERE 	PRS_KEYNO 	=  #{PRS_KEYNO}
		AND   	PRS_DEL_YN 	= 'N'
	</select>
	
		<!-- 스킨 히스토리버전 -->	
	<select id="get_historyVersion" resultType="double">
		SELECT IFNULL(MAX(PRSH_VERSION),0)
		FROM T_PAGE_RESEARCH_SKIN_HISTORY
		WHERE PRSH_PRS_KEYNO = #{PRS_KEYNO}
	</select>
	
		<!-- 스킨 히스토리 등록 -->
	<insert id ="PRSH_insert" parameterType="ResearchSkinDTO">
	<![CDATA[
		INSERT INTO T_PAGE_RESEARCH_SKIN_HISTORY(
			 PRSH_KEYNO
			,PRSH_PRS_KEYNO
			,PRSH_DATA
			,PRSH_STDT
			,PRSH_ENDT
			,PRSH_MODNM
			,PRSH_VERSION
			,PRSH_COMMENT
			)
		VALUES(
			 #{PRSH_KEYNO}
			,#{PRSH_PRS_KEYNO}
			,#{PRSH_DATA}
			,#{PRSH_STDT}
			,now()
			,#{PRSH_MODNM}
			,#{PRSH_VERSION}
			,#{PRSH_COMMENT}
			)
	]]>
	</insert>
	
		<!--  스킨 히스토리 데이터 -->
	<select id="PRSH_getData" parameterType="ResearchSkinDTO" resultType="ResearchSkinDTO">
		SELECT 		*
		FROM		T_PAGE_RESEARCH_SKIN_HISTORY
		WHERE		PRSH_KEYNO	=	#{PRSH_KEYNO}
	</select>
    
    	<!-- 스킨 히스토리 비교 데이터 -->
	<select id="PRSH_compareData" parameterType="ResearchSkinDTO" resultType="ResearchSkinDTO">
		<if test='PRS_KEYNO != "undefined"'>
			SELECT       PRS_FORM 
	        FROM       T_PAGE_RESEARCH_SKIN 
	        WHERE       PRS_KEYNO   =   #{PRS_KEYNO}
			UNION ALL
		</if>
		<![CDATA[
		(
			SELECT 		PRSH_DATA PRS_FORM 
			FROM		T_PAGE_RESEARCH_SKIN_HISTORY
			WHERE		PRSH_PRS_KEYNO	= (
											SELECT PRSH_PRS_KEYNO 
											FROM T_PAGE_RESEARCH_SKIN_HISTORY
											WHERE PRSH_KEYNO   =  #{PRSH_KEYNO}
										  )
			AND			PRSH_DEL_YN		=	'N'
	        AND			PRSH_KEYNO		<=  #{PRSH_KEYNO}
			ORDER BY	PRSH_ENDT DESC
	        LIMIT 2
		)
		]]>
	</select>
	
	   <!-- 스킨 사용여부 검사 -->
	<select id="PRS_getSkinUsing"  resultType="int">
			SELECT 	COUNT(*)
			FROM 	S_HOME_MANAGER 
			WHERE 	HM_RESEARCH_SKIN = #{PRS_KEYNO}
	</select>   
	
	  <!-- 스킨 사용중인 홈페이지 출력 -->
	<select id="PRS_getSkinUsingHP" parameterType="ResearchSkinDTO" resultType="Hashmap">
			SELECT 	GROUP_CONCAT(M.MN_NAME) PRS_HP
			FROM 	S_HOME_MANAGER
			LEFT JOIN S_MENU_MANAGER M
			ON HM_MN_HOMEDIV_C = M.MN_KEYNO			
			GROUP BY HM_RESEARCH_SKIN
			HAVING HM_RESEARCH_SKIN = #{PRS_KEYNO}
	</select>  	
	
	<select id="getSkinForm" resultType="String">
		SELECT 	PRS_FORM
		FROM 	T_PAGE_RESEARCH_SKIN
		WHERE 	PRS_KEYNO = #{PRS_KEYNO}
	</select>
	
</mapper>
 