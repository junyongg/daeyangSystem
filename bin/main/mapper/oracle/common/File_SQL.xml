<?xml version="1.0" encoding="UTF-8"?>
<!DOCTYPE mapper PUBLIC "-//mybatis.org//DTD Mapper 3.0//EN" "http://mybatis.org/dtd/mybatis-3-mapper.dtd">
<mapper namespace="File"> 
  
		
  	
  	<!-- 메인 파일 존재 여부 조회 -->
	<select id="AFM_MainFileChecking" resultType="int" parameterType="FileMain">
 		 SELECT 	COUNT(*)
       	 FROM 		S_COMMON_FILE_MAIN
       	 WHERE 		FM_KEYNO = #{FM_KEYNO}
    </select>
	
	<!-- 메인 파일 정보 등록 처리 -->
	<insert id="AFM_FileInfoInsert" parameterType="FileMain">
       	INSERT INTO S_COMMON_FILE_MAIN
		(
			   FM_KEYNO
			 , FM_REGDT
			 , FM_REGNM
			 , FM_WHERE_KEYS
       		 , FM_COMMENTS
			 , FM_ZIP_PATH
		)
		VALUES
		(
	   		   FM_SEQ.NEXTVAL
			 , SYSDATE
			 , #{FM_REGNM}
			 , #{FM_WHERE_KEYS}
      	     , #{FM_COMMENTS}
      	     , #{FM_ZIP_PATH}
		)
		<selectKey resultType="String" keyProperty="FM_KEYNO" order="AFTER">
			SELECT FM_SEQ.CURRVAL  FROM DUAL
		</selectKey>
    </insert>
	
	<!-- 서브 파일 정보 등록 처리 -->
	<insert id="AFS_FileInfoInsert" parameterType="FileSub">
       	INSERT INTO S_COMMON_FILE_SUB
		(
			 FS_KEYNO
			,FS_FM_KEYNO
			,FS_FILE_SIZE
			,FS_ORINM
			,FS_CHANGENM
			,FS_EXT
			,FS_FOLDER
			,FS_M_KEYNO
			,FS_REGDT
			,FS_REGNM
			,FS_THUMBNAIL
			,FS_ALT
	        ,FS_COMMENTS
	        ,FS_ORIWIDTH
	        ,FS_ORIHEIGHT
	        <!-- 이미지 추가 -->
			,FS_STORAGE
			,FS_PUBLIC_PATH
			,FS_CONVERT_CHK
		)
		VALUES
		(
   		  FS_SEQ.NEXTVAL
		 ,#{FS_FM_KEYNO}
		 ,#{FS_FILE_SIZE}
		 ,#{FS_ORINM}
	  	 ,#{FS_CHANGENM}
	     ,#{FS_EXT}
	     ,#{FS_FOLDER}
	     ,#{FS_M_KEYNO}
	     ,SYSDATE
	     ,#{FS_REGNM}
	     ,#{FS_THUMBNAIL}
	     ,#{FS_ALT}
         ,#{FS_COMMENTS}
         ,#{FS_ORIWIDTH}
         ,#{FS_ORIHEIGHT}
         ,#{FS_STORAGE}
		 ,#{FS_PUBLIC_PATH}
		 ,#{FS_CONVERT_CHK}
		)
		<selectKey resultType="String" keyProperty="FS_KEYNO" order="AFTER">
			SELECT FS_SEQ.CURRVAL  FROM DUAL
		</selectKey>
    </insert>
	
	<!-- 메인키별 파일 목록 조회 -->
	<select id="AFS_FileSelectPutMainkey" resultType="FileSub" parameterType="FileSub">
 	     SELECT 	a.*, NVL2(a.FS_THUMBNAIL, ('/resources/img/upload/'||FS_FOLDER||FS_THUMBNAIL||'.'||FS_EXT),'') AS FS_PATH
       	 FROM 		S_COMMON_FILE_SUB a
       	 WHERE 		FS_FM_KEYNO = #{FS_FM_KEYNO}
       	 ORDER BY	FS_ORDER, FS_KEYNO
    </select>
     
    
	<!-- 서브 파일 키로 상세 조회 -->
	<select id="AFS_SubFileDetailselect" resultType="FileSub" parameterType="FileSub" >
 		 SELECT 	A.*
 		 			,  FS_FOLDER||FS_THUMBNAIL||'.'||FS_EXT AS FS_PATH
       	 FROM 		S_COMMON_FILE_SUB A
       	 WHERE		FS_KEYNO = #{FS_KEYNO}
    </select>
    
     <!-- 메인키로 서브 상세 조회 -->
	<select id="AFS_SubFileselectpath" resultType="FileSub" parameterType="FileSub" >
 		 SELECT 	A.*
 		 			, FS_FOLDER||FS_CHANGENM||'.'||FS_EXT FS_PATH  
       	 FROM 		S_COMMON_FILE_SUB A
       	 WHERE		FS_FM_KEYNO = #{FS_FM_KEYNO}
    </select>
    
    <!-- 서브 파일 다운로드 카운팅 처리 -->
	<update id="AFS_FileDownCouting" parameterType="FileSub" >
	<![CDATA[
		UPDATE		S_COMMON_FILE_SUB
		SET			FS_DOWNCNT	=	FS_DOWNCNT + 1
		WHERE		FS_KEYNO 	= 	#{FS_KEYNO}
	]]>
	</update>
	
	<!-- 업로드 수정시 파일 삭제 처리 -->
	<delete id="AFS_FileUploadDelete" parameterType="FileSub">
	<![CDATA[
		DELETE	FROM	S_COMMON_FILE_SUB
		WHERE	FS_KEYNO = #{FS_KEYNO}
	]]>
	</delete>
	
	
	
    
    
    
    <!-- test: File Sub 조회 -->
	<select id="AFS_FileSelectFileSub" resultType="FileSub" parameterType="hashmap">
 		 SELECT 	FS_KEYNO,
 		 			FS_FM_KEYNO,
 		 			FS_FILE_SIZE,
 		 			FS_ORINM,
 		 			FS_CHANGENM,
 		 			FS_EXT,
 		 			FS_FOLDER,
 		 			FS_ALT,
          			FS_COMMENTS,
          			FS_ORDER,
          			FS_PUBLIC_PATH,
 			        FS_PUBLIC_PATH,
    			 	FS_CONVERT_PATH,
 		 			FS_CONVERT_CHK,
 		 			FS_STORAGE,
 		 			FS_FOLDER || FS_CHANGENM || '.' || FS_EXT AS FS_PATH
 		 			<if test="PATH != NULL">
 		 			,#{PATH} || FS_FOLDER || FS_CHANGENM || '.' || FS_EXT AS PATH
 		 			</if>
       	 FROM 		S_COMMON_FILE_SUB
       	 WHERE		FS_FM_KEYNO = #{FM_KEYNO}
       	 ORDER BY 	FS_ORDER
    </select>
    
    <!-- test: File Sub 삭제 -->
	<delete id="AFS_FileDeleteFileSub" parameterType="FileSub">
 		 DELETE FROM S_COMMON_FILE_SUB
       	 where		FS_KEYNO = #{FS_KEYNO}
    </delete>
    
    <!-- 메인 파일 정보 등록 업데이트 -->
    <update id="AFM_FileUPdate" parameterType="FileMain">
    	UPDATE S_COMMON_FILE_MAIN
    	SET FM_ZIP_PATH = #{FM_ZIP_PATH}
    	WHERE FM_KEYNO = #{FM_KEYNO}
    </update>
    
	<!-- 메인 파일 조회 -->
	<select id="AFM_FileSelect" resultType="FileMain" parameterType="FileMain">
		SELECT FM.*, (SELECT BN_TITLE FROM B_BOARD_NOTICE WHERE BN_FM_KEYNO = #{FM_KEYNO}) ZIP_NAME
		FROM S_COMMON_FILE_MAIN FM
		WHERE FM_KEYNO = #{FM_KEYNO}
	</select>
	<!-- 파일서브 구하기 -->
    <select id="GetSubInfo" parameterType="String" resultType="FileSub">
    	SELECT *
    	FROM S_COMMON_FILE_SUB 
    	WHERE FS_FM_KEYNO= #{FM_KEYNO}
    </select>
	
	<update id="ChSubData" parameterType="FileSub">
		UPDATE  S_COMMON_FILE_SUB
		SET 	FS_FOLDER 		= #{FS_FOLDER}
			 , 	FS_PUBLIC_PATH 	= #{FS_PUBLIC_PATH}
		WHERE 	FS_KEYNO = #{FS_KEYNO}
	</update>
	
	<update id="updateConvChk" parameterType="FileSub">
		UPDATE  S_COMMON_FILE_SUB
		SET 	FS_CONVERT_CHK = #{FS_CONVERT_CHK}
				,FS_CONVERT_PATH = #{FS_CONVERT_PATH}
		WHERE 	FS_KEYNO = #{FS_KEYNO}
	</update>
	
		 <!-- 파일서브키 구하기 -->
    <select id="GetSubKey" parameterType="String" resultType="String">
    	SELECT FS_KEYNO
    	FROM S_COMMON_FILE_SUB 
    	WHERE FS_FM_KEYNO= #{FM_KEYNO}
    </select>
	
</mapper>
 